{# talegoTK_flask/templates/books/actualizar_libro.html #}
{% extends 'base.html' %}
{% block title %}Editar Libro: {{ libro_data.titulo }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-7">
            <header class="text-center mb-4">
                <h1>Editar Libro: <span class="fw-bold">{{ libro_data.titulo }}</span></h1>
            </header>
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-light text-dark fw-bold">
                    Datos del Libro
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('books.editar_libro', book_id=libro_id, next=next_url) if next_url else url_for('books.editar_libro', book_id=libro_id) }}">
                        <dl class="row mb-0">
                            <dt class="col-sm-4 text-secondary">Número de Registro:</dt>
                            <dd class="col-sm-8">
                                <input type="text" class="form-control" value="{{ libro_data.id }}" readonly disabled>
                            </dd>

                            {# Título #}
                            <dt class="col-sm-4 text-secondary">Título <span class="text-danger">*</span>:</dt>
                            <dd class="col-sm-8">
                                <div class="autocomplete-wrapper">
                                    <input type="text" class="form-control autocomplete-input" id="titulo" name="titulo" required
                                           value="{{ request.form.get('titulo', libro_data.titulo) | default('') }}">
                                </div>
                            </dd>

                            {# Subtítulo #}
                            <dt class="col-sm-4 text-secondary">Subtítulo:</dt>
                            <dd class="col-sm-8">
                                <input type="text" class="form-control" id="subtitulo" name="subtitulo"
                                       value="{{ request.form.get('subtitulo', libro_data.subtitulo) | default('') }}">
                                <small class="form-text text-muted">Opcional.</small>
                            </dd>

                            {# Autor Principal (Obligatorio) - Con Autocompletado #}
                            <dt class="col-sm-4 text-secondary">Autor Principal <span class="text-danger">*</span>:</dt>
                            <dd class="col-sm-8">
                                <div class="autocomplete-wrapper">
                                    <input type="text" class="form-control autocomplete-input" id="autor_principal" name="autor_principal" required
                                           value="{{ request.form.get('autor_principal', libro_data.autor_principal_nombre) | default('') }}">
                                </div>
                            </dd>

                            {# Segundo Autor #}
                            <dt class="col-sm-4 text-secondary">Segundo Autor:</dt>
                            <dd class="col-sm-8">
                                <div class="autocomplete-wrapper">
                                    <input type="text" class="form-control autocomplete-input" id="segundo_autor" name="segundo_autor"
                                           value="{{ request.form.get('segundo_autor', libro_data.segundo_autor) | default('') }}">
                                </div>
                                <small class="form-text text-muted">Opcional.</small>
                            </dd>

                            {# Tercer Autor #}
                            <dt class="col-sm-4 text-secondary">Tercer Autor:</dt>
                            <dd class="col-sm-8">
                                <div class="autocomplete-wrapper">
                                    <input type="text" class="form-control autocomplete-input" id="tercer_autor" name="tercer_autor"
                                           value="{{ request.form.get('tercer_autor', libro_data.tercer_autor) | default('') }}">
                                </div>
                                <small class="form-text text-muted">Opcional.</small>
                            </dd>

                            {# Campo CDU #}
                            <dt class="col-sm-4 text-secondary">Código CDU<span class="text-danger">*</span>:</dt>
                            <dd class="col-sm-8">
                                <div class="autocomplete-wrapper">
                                    <input type="text" class="form-control autocomplete-input" id="codigo_cdu" name="codigo_cdu" required
                                           value="{{ request.form.get('codigo_cdu', libro_data.codigo_cdu) | default('') }}">
                                </div>
                            </dd>

                            {# Campo Materia #}
                            <dt class="col-sm-4 text-secondary">Materia <span class="text-danger">*</span>:</dt>
                            <dd class="col-sm-8">
                                <div class="autocomplete-wrapper">
                                    <input type="text" class="form-control autocomplete-input" id="materia" name="materia" required
                                           value="{{ request.form.get('materia', libro_data.materia) | default('') }}">
                                </div>
                            </dd>

                            {# Año #}
                            <dt class="col-sm-4 text-secondary">Año:</dt>
                            <dd class="col-sm-8">
                                <input type="number" class="form-control" id="anio" name="anio"
                                       value="{{ request.form.get('anio', libro_data.anio) | default('') }}">
                                <small class="form-text text-muted">Opcional.</small>
                            </dd>

                            {# Editorial #}
                            <dt class="col-sm-4 text-secondary">Editorial <span class="text-danger">*</span>:</dt>
                            <dd class="col-sm-8">
                                <div class="autocomplete-wrapper">
                                    <input type="text" class="form-control autocomplete-input" id="nombre_editorial" name="nombre_editorial" required
                                           value="{{ request.form.get('nombre_editorial', libro_data.nombre_editorial) | default('') }}">
                                </div>
                            </dd>

                            {# Idioma #}
                            <dt class="col-sm-4 text-secondary">Idioma <span class="text-danger">*</span>:</dt>
                            <dd class="col-sm-8">
                                <div class="autocomplete-wrapper">
                                    <input type="text" class="form-control autocomplete-input" id="nombre_idioma" name="nombre_idioma" required
                                           value="{{ request.form.get('nombre_idioma', libro_data.nombre_idioma) | default('') }}">
                                </div>
                            </dd>

                            {# Páginas #}
                            <dt class="col-sm-4 text-secondary">Páginas:</dt>
                            <dd class="col-sm-8">
                                <input type="number" class="form-control" id="paginas" name="paginas"
                                       value="{{ request.form.get('paginas', libro_data.paginas) | default('') }}">
                                <small class="form-text text-muted">Opcional.</small>
                            </dd>

                            {# ISBN #}
                            <dt class="col-sm-4 text-secondary">ISBN:</dt>
                            <dd class="col-sm-8">
                                <input type="text" class="form-control" id="isbn" name="isbn"
                                       value="{{ request.form.get('isbn', libro_data.isbn) | default('') }}">
                                <small class="form-text text-muted">Opcional.</small>
                            </dd>

                            {# Observaciones #}
                            <dt class="col-sm-4 text-secondary">Observaciones:</dt>
                            <dd class="col-sm-8">
                                <textarea class="form-control" id="observaciones" name="observaciones" rows="5">{{ request.form.get('observaciones', libro_data.observaciones) | default('') }}</textarea>
                                <small class="form-text text-muted">Opcional.</small>
                            </dd>

                            {# Disponible #}
                            <dt class="col-sm-4 text-secondary">Disponible:</dt>
                            <dd class="col-sm-8">
                                <input type="text" class="form-control" value="{{ libro_data.disponible }}" readonly disabled>
                            </dd>
                        </dl>

                        <hr class="mt-4 mb-3">

                        <div class="d-flex justify-content-end mt-4">
                            <a href="{{ next_url or url_for('books.ver_ficha', book_id=libro_id) }}" class="btn btn-secondary me-2">Cancelar</a>
                            <button type="submit" class="btn btn-success">Guardar Cambios</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
{{ super() }}
<script>
    /**
     * Configura un campo de entrada para autocompletado directamente en la plantilla.
     * @param {string} inputId - El ID del elemento <input>.
     * @param {string} endpointUrl - La URL del endpoint de la API de autocompletado (ej: '/libros/autocomplete/autores').
     * @param {number} delay - El retraso en milisegundos antes de hacer la petición AJAX (para debounce).
     */
    function setupAutocomplete(inputId, endpointUrl, delay = 300) {
        const inputElement = document.getElementById(inputId);
        if (!inputElement) {
            console.warn(`Autocomplete: Elemento con ID "${inputId}" no encontrado.`);
            return;
        }

        let debounceTimeout;
        let currentFocus = -1;
        let isSelectingSuggestion = false;

        // Crear el contenedor de sugerencias
        const autocompleteContainer = document.createElement('div');
        inputElement.parentNode.insertBefore(autocompleteContainer, inputElement.nextSibling);

        autocompleteContainer.setAttribute('class', 'autocomplete-items');

        inputElement.addEventListener('input', function(e) {
            const value = this.value;

            if (isSelectingSuggestion) {
                isSelectingSuggestion = false; // Resetea la bandera
                return; // No procesa el evento 'input' si viene de una selección
            }


            closeAllLists(); // Cerrar cualquier lista abierta

            if (!value) {
                return false;
            }

            clearTimeout(debounceTimeout);
            debounceTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`${endpointUrl}?term=${encodeURIComponent(value)}`);
                    if (!response.ok) {
                        throw new Error(`Error HTTP: ${response.status}`);
                    }
                    const data = await response.json(); // Se espera un array de strings

                    currentFocus = -1; // Resetear foco

                    data.forEach(item => {
                        // Crear un div para cada sugerencia
                        const suggestionDiv = document.createElement('div');
                        // Resaltar la coincidencia
                        const valueUpper = value.toUpperCase();
                        const itemUpper = item.toUpperCase();
                        const startMatch = itemUpper.indexOf(valueUpper);
                        if (startMatch !== -1) {
                            suggestionDiv.innerHTML = item.substring(0, startMatch) +
                                                      `<strong>${item.substring(startMatch, startMatch + value.length)}</strong>` +
                                                      item.substring(startMatch + value.length);
                        } else {
                            // Si no hay coincidencia directa, simplemente mostrar el ítem
                            suggestionDiv.innerHTML = item;
                        }

                        suggestionDiv.innerHTML += `<input type='hidden' value='${item}'>`; // Valor real en un input oculto

                        suggestionDiv.addEventListener('click', function(e) {
                            isSelectingSuggestion = true;
                            inputElement.value = this.getElementsByTagName('input')[0].value;
                            closeAllLists(); // Cerrar la lista después de seleccionar
                            // Disparar evento 'input' manualmente para que la lógica de mayúsculas se active
                            const event = new Event('input', { bubbles: true });
                            inputElement.dispatchEvent(event);
                        });
                        autocompleteContainer.appendChild(suggestionDiv);
                    });
                } catch (error) {
                    console.error('Error fetching autocomplete suggestions:', error);
                }
            }, delay);
        });

        // Manejo de teclado para navegar por las sugerencias
        inputElement.addEventListener('keydown', function(e) {
            let x = autocompleteContainer.getElementsByTagName('div');
            // Filtrar solo los elementos visibles dentro del contenedor
            if (x) x = Array.from(x).filter(el => el.offsetParent !== null); // Convertir a array y filtrar
            else return;

            if (e.keyCode == 40) { // Flecha hacia abajo
                currentFocus++;
                addActive(x);
            } else if (e.keyCode == 38) { // Flecha hacia arriba
                currentFocus--;
                addActive(x);
            } else if (e.keyCode == 13) { // Enter
                e.preventDefault(); // Prevenir el envío del formulario si está activa una sugerencia
                if (currentFocus > -1) {
                    if (x && x[currentFocus]) x[currentFocus].click();
                } else {
                    closeAllLists();
                }
            } else if (e.keyCode == 27) { // Escape
                closeAllLists();
            }
        });

        function addActive(x) {
            if (!x || x.length === 0) return false;
            removeActive(x);
            if (currentFocus >= x.length) currentFocus = 0;
            if (currentFocus < 0) currentFocus = (x.length - 1);
            x[currentFocus].classList.add('autocomplete-active');
        }

        function removeActive(x) {
            for (let i = 0; i < x.length; i++) {
                x[i].classList.remove('autocomplete-active');
            }
        }

        function closeAllLists(elmnt) {
            const allAutocompleteItems = document.querySelectorAll('.autocomplete-items');
            allAutocompleteItems.forEach(item => {
                // Solo cerrar si no es el elemento clicado o el input que está activo
                if (item !== elmnt && item !== inputElement) {
                    item.innerHTML = ''; // Vaciar el contenedor de sugerencias
                }
            });
        }

        // Cerrar las sugerencias si se hace clic fuera del input o la lista
        document.addEventListener('click', function(e) {
            // Asegurarse de que el clic no fue en el input o en el contenedor de sugerencias
            if (e.target !== inputElement && !autocompleteContainer.contains(e.target)) {
                closeAllLists();
            }
        });
    } // Fin de setupAutocomplete function

    document.addEventListener('DOMContentLoaded', function() {
        // JavaScript para convertir texto a mayúsculas al escribir, con excepciones
        document.querySelectorAll('input[type="text"], textarea').forEach(function(element) {
            // Campos que NO deben convertirse a MAYÚSCULAS: 'observaciones', 'isbn', y los deshabilitados
            if (element.id !== 'observaciones' && element.id !== 'isbn' && !element.disabled) {
                element.addEventListener('input', function() {
                    this.value = this.value.toUpperCase();
                });
            }
        });

        // Configurar los campos con autocompletado
        setupAutocomplete('titulo', '{{ url_for('books.autocomplete_titulos') }}');
        setupAutocomplete('autor_principal', '{{ url_for('books.autocomplete_autores') }}');
        setupAutocomplete('segundo_autor', '{{ url_for('books.autocomplete_autores') }}');
        setupAutocomplete('tercer_autor', '{{ url_for('books.autocomplete_autores') }}');
        setupAutocomplete('codigo_cdu', '{{ url_for('books.autocomplete_cdu_codigos') }}');
        setupAutocomplete('materia', '{{ url_for('books.autocomplete_cdu_materias') }}');
        setupAutocomplete('nombre_editorial', '{{ url_for('books.autocomplete_editoriales') }}');
        setupAutocomplete('nombre_idioma', '{{ url_for('books.autocomplete_idiomas') }}');
    });
</script>
{% endblock %}